---
- name: Ensure unzip is installed.
  ansible.builtin.apt:
    cache_valid_time: 86400  # 24 hours
    name: unzip
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: Testing 'avinode.devenv.install_terraform_versions'
  block:
    # -------------------------------------------------------------------------
    # Arrange
    # -------------------------------------------------------------------------
    - name: Create temporary test directory
      ansible.builtin.tempfile:
        state: directory
        suffix: .install-terraform-integration-tests
      register: _tmp_test_dir
    - set_fact:
        avinode_devenv_prefix: '{{ _tmp_test_dir.path }}'
    - include_role:
        name: avinode.devenv.baseline

    # -------------------------------------------------------------------------
    # Test install
    # -------------------------------------------------------------------------
    - name: Executing `install_terraform_versions` to test installs
      import_role:
        name: avinode.devenv.install_terraform_versions
      vars:
        install_terraform_versions:
          absent: []
          absent_symlinks: []
          installed:
            - '0.14.7'
            - '1.0.1'
          symlinks:
            terraform0.14: '0.14.7'
            terraform1: '1.0.1'
            terraform: '1.0.1'

    - name: Test that bins have been installed.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_installed_bins.yaml
      vars:
        test_files:
          - '{{ _tmp_test_dir.path }}/bin/terraform'
          - '{{ _tmp_test_dir.path }}/bin/terraform0.14'
          - '{{ _tmp_test_dir.path }}/bin/terraform0.14.7'
          - '{{ _tmp_test_dir.path }}/bin/terraform1'
          - '{{ _tmp_test_dir.path }}/bin/terraform1.0.1'

    - name: Test that Bash completions have been installed.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_installed_bash_completions.yaml
      vars:
        test_files:
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform0.14'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform0.14.7'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform1'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform1.0.1'

    # -------------------------------------------------------------------------
    # Test uninstall
    # -------------------------------------------------------------------------
    - name: Executing `install_terraform_versions` to test uninstalls
      include_role:
        name: avinode.devenv.install_terraform_versions
      vars:
        install_terraform_versions:
          absent:
            - '0.14.7'
          absent_symlinks:
            - terraform0.14
          installed: []
          symlinks: {}

    # Check that files have been removed.
    - name: Test that bins are uninstalled.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_uninstalled_bins.yaml
      vars:
        test_files:
          - terraform0.14
          - terraform0.14.7

    - name: Test that Bash completions are uninstalled.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_uninstalled_bash_completions.yaml
      vars:
        test_files:
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform0.14'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform0.14.7'

    # Check that originals are still in place.
    - name: Test that original bins are still there.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_installed_bins.yaml
      vars:
        test_files:
          - '{{ _tmp_test_dir.path }}/bin/terraform'
          - '{{ _tmp_test_dir.path }}/bin/terraform1'
          - '{{ _tmp_test_dir.path }}/bin/terraform1.0.1'

    - name: Test that original Bash completions are still there.
      ansible.builtin.include_role:
        name: avinode.devenv.test_helpers
        tasks_from: test_installed_bash_completions.yaml
      vars:
        test_files:
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform1'
          - '{{ _tmp_test_dir.path }}/etc/bash_completion.d/terraform1.0.1'

  always:
    - name: Delete temporary test directory
      ansible.builtin.file:
        path: '{{ _tmp_test_dir.path }}'
        state: absent
  vars:
    avinode_devenv_become_for_all: false
    avinode_devenv_default_group: '{{ ansible_user_gid }}'
    avinode_devenv_default_owner: '{{ ansible_user_id }}'
...
